# 3-2. äº‹ä»¶æ¨¡å— - GameEvent

## ğŸ¯ æ¨¡å—æ¦‚è¿°

TEngine äº‹ä»¶æ¨¡å—æ˜¯ä¸€ä¸ª**é«˜æ•ˆä¸”é›¶ GC**çš„äº‹ä»¶ç³»ç»Ÿï¼Œæ”¯æŒæŒ‡å®šäº‹ä»¶ IDï¼ˆint/stringï¼‰è¿›è¡Œç›‘å¬å’Œåˆ†å‘ã€‚é€šè¿‡äº‹ä»¶æ¥é©±åŠ¨æ¨¡å—ï¼Œå¦‚æˆ˜æ–—çš„è§’è‰²èº«ä¸Šçš„äº‹ä»¶æµã€UI å’Œç½‘ç»œä»¥åŠ Model çš„æ•°æ®æµï¼Œå¼€å‘ä¸­çš„ç»å¤§éƒ¨åˆ†æƒ…å†µéƒ½å¯ä»¥é€šè¿‡äº‹ä»¶æ¥è¿›è¡Œé©±åŠ¨ã€‚

é…åˆ UI æ¨¡å—æˆ–æ‹“å±•çš„æˆ˜æ–—æ¨¡å—å¯ä»¥å®ç° **MVEï¼ˆModel - View - Eventï¼‰äº‹ä»¶é©±åŠ¨æ¶æ„**ã€‚

### âœ¨ æ ¸å¿ƒä¼˜åŠ¿

1. **âš¡ é›¶ GC è®¾è®¡**
   - ä½¿ç”¨ int ç±»å‹äº‹ä»¶ IDï¼Œé¿å…å­—ç¬¦ä¸²å“ˆå¸Œè®¡ç®—
   - ä¼˜åŒ–çš„æ•°æ®ç»“æ„ï¼Œå‡å°‘å†…å­˜åˆ†é…
   - é€‚åˆé«˜é¢‘äº‹ä»¶åœºæ™¯

2. **ğŸ”§ çµæ´»çš„äº‹ä»¶ç±»å‹**
   - æ”¯æŒ `int` ç±»å‹äº‹ä»¶ IDï¼ˆæ¨èï¼Œæ€§èƒ½æœ€ä½³ï¼‰
   - æ”¯æŒ `string` ç±»å‹äº‹ä»¶ IDï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
   - ä½¿ç”¨ `StringId.StringToHash` æ–¹æ³•å®šä¹‰äº‹ä»¶ IDï¼Œè¾¾åˆ°æœ€ä½³æ€§èƒ½

3. **ğŸ¯ ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†**
   - UI æ¨¡å—çš„äº‹ä»¶å’Œ UI ç”Ÿå‘½å‘¨æœŸå­˜åœ¨ç»‘å®š
   - é”€æ¯ UI æ—¶å¯ä»¥è‡ªåŠ¨ç§»é™¤ UI æ‰€ç›‘å¬çš„äº‹ä»¶
   - å¼€å‘è¿‡ç¨‹ä¸­åªéœ€è¦å…³å¿ƒæ·»åŠ äº‹ä»¶ï¼Œé¿å…äº†å…³é—­ UI ä½†æ²¡æœ‰ç§»é™¤äº‹ä»¶ç›‘å¬çš„é—®é¢˜

4. **ğŸ“Š æ”¯æŒå¤šå‚æ•°äº‹ä»¶**
   - æ”¯æŒ 0-6 ä¸ªæ³›å‹å‚æ•°çš„äº‹ä»¶
   - ç±»å‹å®‰å…¨çš„äº‹ä»¶ä¼ é€’

---

## ğŸ“– åŸºç¡€ä½¿ç”¨

### å®šä¹‰äº‹ä»¶ ID

```csharp
// æ–¹å¼1ï¼šä½¿ç”¨ StringId.StringToHashï¼ˆæ¨èï¼Œæ€§èƒ½æœ€ä½³ï¼‰
public static readonly int EventPlayerHpChange = StringId.StringToHash("Player.HpChange");
public static readonly int EventPlayerLevelUp = StringId.StringToHash("Player.LevelUp");

// æ–¹å¼2ï¼šç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼Œä½†æ€§èƒ½ç•¥ä½ï¼‰
const string EventPlayerHpChangeStr = "Player.HpChange";
```

### æ³¨å†Œäº‹ä»¶ç›‘å¬

```csharp
class PlayerHpBar
{
    public PlayerHpBar()
    {
        // æ–¹å¼1ï¼šä½¿ç”¨ int äº‹ä»¶ IDï¼ˆæ¨èï¼‰
        GameEvent.AddEventListener(EventPlayerHpChange, OnPlayerHpChange);
        
        // æ–¹å¼2ï¼šä½¿ç”¨ string äº‹ä»¶ ID
        GameEvent.AddEventListener("Player.HpChange", OnPlayerHpChange);
        
        // æ–¹å¼3ï¼šå¸¦å‚æ•°çš„äº‹ä»¶
        GameEvent.AddEventListener<int>(EventPlayerHpChange, OnPlayerHpChangeWithValue);
    }
    
    private void OnPlayerHpChange()
    {
        // å¤„ç†äº‹ä»¶
    }
    
    private void OnPlayerHpChangeWithValue(int newHp)
    {
        // å¤„ç†å¸¦å‚æ•°çš„äº‹ä»¶
    }
}
```

### å‘é€äº‹ä»¶

```csharp
class PlayerManager
{
    private void OnHpChanged(int newHp)
    {
        // æ–¹å¼1ï¼šä½¿ç”¨ int äº‹ä»¶ IDï¼ˆæ¨èï¼‰
        GameEvent.Send(EventPlayerHpChange);
        GameEvent.Send(EventPlayerHpChange, newHp);
        
        // æ–¹å¼2ï¼šä½¿ç”¨ string äº‹ä»¶ ID
        GameEvent.Send("Player.HpChange");
        GameEvent.Send("Player.HpChange", newHp);
    }
}
```

---

## ğŸ® å®Œæ•´ç¤ºä¾‹ï¼šMVE æ¶æ„

### åœºæ™¯ï¼šæ¸¸æˆä¸­è¡€é‡æ‰£é™¤

å½“æœåŠ¡å™¨å‘æ¥å‡å°‘ Hp çš„æ¶ˆæ¯åŒ…æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. åœ¨æ”¶åˆ°æ¶ˆæ¯åŒ…æ—¶å‘é€ä¸€ä¸ªäº‹ä»¶æµ
2. åœ¨ç©å®¶å¤´é¡¶çš„ HP è¿›åº¦æ¡ç»„ä»¶/å·¦ä¸Šè§’ Hp çš„ UI è¡€æ¡ç»„ä»¶æ·»åŠ ç›‘å¬äº‹ä»¶
3. å„ä¸ªæ¨¡å—è´Ÿè´£è‡ªå·±ç›‘å¬åçš„é€»è¾‘

```csharp
// å®šä¹‰äº‹ä»¶ ID
public static class PlayerEventDefined
{
    public static readonly int OnHpChange = StringId.StringToHash("Player.HpChange");
    public static readonly int OnLevelUp = StringId.StringToHash("Player.LevelUp");
}

// æœåŠ¡å™¨æ¶ˆæ¯å¤„ç†
class ClientHandle
{
    private void HandleMessage(MainPack mainpack)
    {
        HpPack hpPack = mainpack.hpPack;
        int playerId = mainpack.playerId;
        var player = PlayerMgr.Instance.GetPlayer(playerId);
        
        if (player != null)
        {
            // å‘é€å…¨å±€äº‹ä»¶
            GameEvent.Send(PlayerEventDefined.OnHpChange, hpPack);
            
            // æˆ–è€…å‘é€å±€éƒ¨äº‹ä»¶ï¼ˆå¦‚æœç©å®¶æœ‰å±€éƒ¨äº‹ä»¶ç®¡ç†å™¨ï¼‰
            // player.Event.Send(PlayerEventDefined.OnHpChange, hpPack);
        }
    }
}

// ç©å®¶å¤´é¡¶ HP æ¡ç»„ä»¶
class PlayerHpBar : MonoBehaviour
{
    private void Start()
    {
        // ç›‘å¬å…¨å±€äº‹ä»¶
        GameEvent.AddEventListener<HpPack>(PlayerEventDefined.OnHpChange, OnHpChange);
    }
    
    private void OnDestroy()
    {
        // ç§»é™¤äº‹ä»¶ç›‘å¬
        GameEvent.RemoveEventListener<HpPack>(PlayerEventDefined.OnHpChange, OnHpChange);
    }
    
    private void OnHpChange(HpPack pack)
    {
        // æ›´æ–° HP æ¡æ˜¾ç¤º
        UpdateHpBar(pack.currentHp, pack.maxHp);
    }
}

// UI è¡€æ¡ç»„ä»¶ï¼ˆè‡ªåŠ¨ç®¡ç†äº‹ä»¶ç”Ÿå‘½å‘¨æœŸï¼‰
[Window(UILayer.Top)]
class BattleMainUI : UIWindow
{
    public override void RegisterEvent()
    {
        // é€šè¿‡ AddUIEvent æ³¨å†Œçš„äº‹ä»¶ä¼šè‡ªåŠ¨ç»‘å®š UI ç”Ÿå‘½å‘¨æœŸ
        // é¢æ¿é”€æ¯æ—¶è‡ªåŠ¨ç§»é™¤ç›‘å¬ï¼Œæ— éœ€æ‰‹åŠ¨ RemoveEventListener
        AddUIEvent<HpPack>(PlayerEventDefined.OnHpChange, OnHpChange);
    }
    
    private void OnHpChange(HpPack pack)
    {
        // æ›´æ–° UI è¡€æ¡æ˜¾ç¤º
        m_hpBar.value = (float)pack.currentHp / pack.maxHp;
    }
}
```

---

## ğŸ”§ API å‚è€ƒ

### äº‹ä»¶æ³¨å†Œ

```csharp
// æ— å‚æ•°äº‹ä»¶
bool AddEventListener(int eventType, Action handler);
bool AddEventListener(string eventType, Action handler);

// 1-6 ä¸ªå‚æ•°äº‹ä»¶
bool AddEventListener<TArg1>(int eventType, Action<TArg1> handler);
bool AddEventListener<TArg1, TArg2>(int eventType, Action<TArg1, TArg2> handler);
bool AddEventListener<TArg1, TArg2, TArg3>(int eventType, Action<TArg1, TArg2, TArg3> handler);
// ... æœ€å¤šæ”¯æŒ 6 ä¸ªå‚æ•°
```

### äº‹ä»¶å‘é€

```csharp
// æ— å‚æ•°äº‹ä»¶
void Send(int eventType);
void Send(string eventType);

// 1-6 ä¸ªå‚æ•°äº‹ä»¶
void Send<TArg1>(int eventType, TArg1 arg1);
void Send<TArg1, TArg2>(int eventType, TArg1 arg1, TArg2 arg2);
void Send<TArg1, TArg2, TArg3>(int eventType, TArg1 arg1, TArg2 arg2, TArg3 arg3);
// ... æœ€å¤šæ”¯æŒ 6 ä¸ªå‚æ•°
```

### äº‹ä»¶ç§»é™¤

```csharp
// ç§»é™¤äº‹ä»¶ç›‘å¬
bool RemoveEventListener(int eventType, Action handler);
bool RemoveEventListener<TArg1>(int eventType, Action<TArg1> handler);
// ... æ”¯æŒæ‰€æœ‰å‚æ•°ç±»å‹
```

### UI äº‹ä»¶ç®¡ç†ï¼ˆè‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸï¼‰

```csharp
// åœ¨ UIBase ä¸­ä½¿ç”¨ï¼Œè‡ªåŠ¨ç®¡ç†äº‹ä»¶ç”Ÿå‘½å‘¨æœŸ
void AddUIEvent(int eventType, Action handler);
void AddUIEvent<T>(int eventType, Action<T> handler);
void AddUIEvent<T, U>(int eventType, Action<T, U> handler);
// ... æœ€å¤šæ”¯æŒ 4 ä¸ªå‚æ•°

// ç§»é™¤æ‰€æœ‰ UI äº‹ä»¶ï¼ˆé€šå¸¸åœ¨ OnDestroy ä¸­è‡ªåŠ¨è°ƒç”¨ï¼‰
void RemoveAllUIEvent();
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä¼˜å…ˆä½¿ç”¨ int ç±»å‹äº‹ä»¶ ID

```csharp
// âœ… æ¨èï¼šä½¿ç”¨ int ç±»å‹ï¼Œæ€§èƒ½æœ€ä½³
public static readonly int EventHpChange = StringId.StringToHash("Player.HpChange");
GameEvent.AddEventListener(EventHpChange, OnHpChange);

// âŒ ä¸æ¨èï¼šä½¿ç”¨ string ç±»å‹ï¼Œæœ‰å“ˆå¸Œè®¡ç®—å¼€é”€
GameEvent.AddEventListener("Player.HpChange", OnHpChange);
```

### 2. ä½¿ç”¨ UI äº‹ä»¶è‡ªåŠ¨ç®¡ç†

```csharp
// âœ… æ¨èï¼šåœ¨ UI ä¸­ä½¿ç”¨ AddUIEventï¼Œè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
[Window(UILayer.Top)]
class BattleUI : UIWindow
{
    public override void RegisterEvent()
    {
        AddUIEvent(EventDefined.OnHpChange, OnHpChange);
        // æ— éœ€æ‰‹åŠ¨ RemoveEventListenerï¼ŒUI é”€æ¯æ—¶è‡ªåŠ¨ç§»é™¤
    }
}

// âŒ ä¸æ¨èï¼šæ‰‹åŠ¨ç®¡ç†äº‹ä»¶ç”Ÿå‘½å‘¨æœŸ
class BattleUI : UIWindow
{
    public override void OnCreate()
    {
        GameEvent.AddEventListener(EventDefined.OnHpChange, OnHpChange);
    }
    
    public override void OnDestroy()
    {
        GameEvent.RemoveEventListener(EventDefined.OnHpChange, OnHpChange);
    }
}
```

### 3. é›†ä¸­å®šä¹‰äº‹ä»¶ ID

```csharp
// âœ… æ¨èï¼šé›†ä¸­å®šä¹‰äº‹ä»¶ ID
public static class GameEventDefined
{
    public static readonly int OnPlayerHpChange = StringId.StringToHash("Player.HpChange");
    public static readonly int OnPlayerLevelUp = StringId.StringToHash("Player.LevelUp");
    public static readonly int OnBattleStart = StringId.StringToHash("Battle.Start");
    public static readonly int OnBattleEnd = StringId.StringToHash("Battle.End");
}
```

### 4. ä½¿ç”¨å±€éƒ¨äº‹ä»¶ç®¡ç†å™¨

å¯¹äºéœ€è¦å±€éƒ¨äº‹ä»¶ç®¡ç†çš„åœºæ™¯ï¼ˆå¦‚ç©å®¶å¯¹è±¡ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `GameEventMgr`ï¼š

```csharp
class Player
{
    private GameEventMgr _eventMgr = MemoryPool.Acquire<GameEventMgr>();
    
    public GameEventMgr Event => _eventMgr;
    
    public void OnDestroy()
    {
        // æ¸…ç†äº‹ä»¶ç®¡ç†å™¨
        MemoryPool.Release(_eventMgr);
    }
}

// ä½¿ç”¨
player.Event.AddEvent(PlayerEventDefined.OnHpChange, OnHpChange);
player.Event.Send(PlayerEventDefined.OnHpChange, hpPack);
```

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ int ç±»å‹äº‹ä»¶ ID**ï¼šé¿å…å­—ç¬¦ä¸²å“ˆå¸Œè®¡ç®—
2. **é¿å…é¢‘ç¹æ³¨å†Œ/ç§»é™¤äº‹ä»¶**ï¼šåœ¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒäº‹ä»¶ç›‘å¬
3. **ä½¿ç”¨ UI äº‹ä»¶è‡ªåŠ¨ç®¡ç†**ï¼šå‡å°‘æ‰‹åŠ¨ç®¡ç†å¸¦æ¥çš„æ€§èƒ½å¼€é”€
4. **åˆç†ä½¿ç”¨äº‹ä»¶å‚æ•°**ï¼šé¿å…ä¼ é€’è¿‡å¤§çš„å¯¹è±¡ï¼Œè€ƒè™‘ä¼ é€’ ID æˆ–å¼•ç”¨

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [UI æ¨¡å—æ–‡æ¡£](./3-5-UIæ¨¡å—.md) - äº†è§£ UI æ¨¡å—å¦‚ä½•ä¸äº‹ä»¶æ¨¡å—é…åˆ
- [æ¡†æ¶æ¦‚è§ˆ](./2-æ¡†æ¶æ¦‚è§ˆ.md) - äº†è§£ MVE æ¶æ„è®¾è®¡
