# 3-6. é…ç½®è¡¨æ¨¡å— - ConfigSystem

## ğŸ“Š æ¨¡å—æ¦‚è¿°

TEngine é…ç½®è¡¨æ¨¡å—é›†æˆäº†æœ€ä½³æ¸¸æˆé…ç½®è§£å†³æ–¹æ¡ˆ **[Luban](https://github.com/focus-creative-games/luban)**ï¼Œæä¾›äº†å®Œæ•´çš„é…ç½®è¡¨å¼€å‘å·¥ä½œæµã€‚

### âœ¨ æ ¸å¿ƒä¼˜åŠ¿

1. **ğŸš€ å¤šç§åŠ è½½æ–¹å¼**
   - **æ‡’åŠ è½½**ï¼šæŒ‰éœ€åŠ è½½é…ç½®ï¼ŒèŠ‚çœå†…å­˜
   - **å¼‚æ­¥åŠ è½½**ï¼šåŸºäº UniTask çš„å¼‚æ­¥åŠ è½½ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
   - **åŒæ­¥åŠ è½½**ï¼šå¿«é€ŸåŒæ­¥åŠ è½½é…ç½®
   - **æœåŠ¡å™¨åŠ è½½**ï¼šæ”¯æŒ Task å¼‚æ­¥åŠ è½½ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

2. **ğŸ“¦ å¼ºå¤§çš„æ•°æ®æ”¯æŒ**
   - æ”¯æŒ Excelã€JSONã€XMLã€YAML ç­‰å¤šç§æ•°æ®æ ¼å¼
   - æ”¯æŒå¤æ‚åµŒå¥—ç»“æ„
   - æ”¯æŒ OOP ç±»å‹ç»§æ‰¿

3. **âœ… å®Œå–„çš„æ•°æ®æ ¡éªŒ**
   - ref å¼•ç”¨æ£€æŸ¥
   - path èµ„æºè·¯å¾„æ£€æŸ¥
   - range èŒƒå›´æ£€æŸ¥
   - ç±»å‹å®‰å…¨æ£€æŸ¥

4. **ğŸŒ æœ¬åœ°åŒ–æ”¯æŒ**
   - é™æ€æ–‡æœ¬å€¼æœ¬åœ°åŒ–
   - åŠ¨æ€æ–‡æœ¬å€¼æœ¬åœ°åŒ–
   - æ—¶é—´æœ¬åœ°åŒ–
   - main-patch å¤šåœ°åŒºç‰ˆæœ¬

---

## ğŸ“ ç›®å½•ç»“æ„

åœ¨ TEngine ä¸­ï¼ŒLuban é…ç½®è¡¨ç›®å½•ä½äºï¼š

```
Configs/GameConfig/
â”œâ”€â”€ CustomTemplate/      # è‡ªå®šä¹‰æ¨¡æ¿
â”œâ”€â”€ Datas/              # é…ç½®è¡¨æ•°æ®ï¼ˆExcelï¼‰
â”œâ”€â”€ Defines/            # é…ç½®è¡¨å®šä¹‰
â””â”€â”€ gen_code_*.bat      # ä»£ç ç”Ÿæˆè„šæœ¬
```

![image](src/3-6-1.png)

---

## ğŸ› ï¸ å®‰è£…ä¸é…ç½®

### 1. å®‰è£… Luban

åœ¨ TEngine æ ¹ç›®å½•åŒçº§å…‹éš†æœ€æ–°çš„ luban-next ä»“åº“ï¼š

![image](src/3-6-2.png)

### 2. æ„å»º Luban

åœ¨ `Tools` ç›®å½•æ‰§è¡Œ `build-luban.bat`ï¼ˆWindowsï¼‰æˆ– `build-luban.sh`ï¼ˆMac/Linuxï¼‰ï¼š

![image](src/3-6-3.png)

### 3. ç”Ÿæˆé…ç½®è¡¨ä»£ç 

åœ¨ `Configs/GameConfig` ç›®å½•ä¸‹æ‰§è¡Œå¯¹åº”çš„ç”Ÿæˆè„šæœ¬ï¼š

- `gen_code_bin_to_project.bat` - ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ï¼ˆåŒæ­¥åŠ è½½ï¼‰
- `gen_code_bin_to_project_lazyload.bat` - ç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ï¼ˆæ‡’åŠ è½½ï¼‰
- `gen_code_bin_to_server.bat` - ç”ŸæˆæœåŠ¡å™¨ä»£ç 

> **æç¤º**ï¼šTEngine å†…ç½®é»˜è®¤ä½¿ç”¨æ‡’åŠ è½½é…ç½®ï¼Œä¹Ÿæ”¯æŒåŸºäº UniTask çš„å¼‚æ­¥åŠ è½½ã€åŒæ­¥åŠ è½½ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨çš„ Task å¼‚æ­¥åŠ è½½ã€‚

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### åŸºç¡€ä½¿ç”¨

```csharp
/// <summary>
/// é“å…·é…ç½®è¡¨ç®¡ç†å™¨ã€‚
/// </summary>
public class ItemConfigMgr : Singleton<ItemConfigMgr>
{
    /// <summary>
    /// é“å…· Tableã€‚
    /// </summary>
    private TbItem TbItem => ConfigLoader.Instance.Tables.TbItem;

    /// <summary>
    /// è·å–é“å…·é…ç½®è¡¨ã€‚
    /// </summary>
    /// <param name="itemId">é“å…·Idã€‚</param>
    /// <returns>é“å…·é…ç½®è¡¨ã€‚</returns>
    public ItemConfig GetItemConfig(int itemId)
    {
        if (TbItem.DataMap.TryGetValue(itemId, out var config))
        {
            return config;
        }
        return null;
    }
    
    /// <summary>
    /// è·å–æ‰€æœ‰é“å…·é…ç½®ã€‚
    /// </summary>
    /// <returns>æ‰€æœ‰é“å…·é…ç½®åˆ—è¡¨ã€‚</returns>
    public List<ItemConfig> GetAllItemConfigs()
    {
        return TbItem.DataList;
    }
}
```

### æ‡’åŠ è½½æ¨¡å¼

```csharp
// æ‡’åŠ è½½ï¼šé¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨åŠ è½½
var itemConfig = ConfigLoader.Instance.Tables.TbItem.Get(itemId);
```

### å¼‚æ­¥åŠ è½½æ¨¡å¼

```csharp
// å¼‚æ­¥åŠ è½½é…ç½®è¡¨
await ConfigLoader.Instance.LoadTablesAsync();
var itemConfig = ConfigLoader.Instance.Tables.TbItem.Get(itemId);
```

### åŒæ­¥åŠ è½½æ¨¡å¼

```csharp
// åŒæ­¥åŠ è½½é…ç½®è¡¨
ConfigLoader.Instance.LoadTables();
var itemConfig = ConfigLoader.Instance.Tables.TbItem.Get(itemId);
```

---

## ğŸ”§ Luban æ ¸å¿ƒç‰¹æ€§

### 1. å¼ºå¤§çš„æ•°æ®è§£æå’Œè½¬æ¢èƒ½åŠ›

æ”¯æŒå¤šç§æ•°æ®æ ¼å¼è¾“å…¥å’Œè¾“å‡ºï¼š

**è¾“å…¥æ ¼å¼**ï¼š
- Excel (CSV, XLS, XLSX)
- JSON
- BSON
- XML
- YAML
- Lua
- Unity ScriptableObject

**è¾“å‡ºæ ¼å¼**ï¼š
- Binary
- JSON
- BSON
- XML
- Lua
- YAML
- Erlang
- Custom Format

### 2. å¢å¼ºçš„ Excel æ ¼å¼

å¯ä»¥ç®€æ´åœ°é…ç½®å‡ºï¼š
- ç®€å•åˆ—è¡¨
- å­ç»“æ„
- ç»“æ„åˆ—è¡¨
- ä»»æ„å¤æ‚çš„æ·±å±‚æ¬¡åµŒå¥—ç»“æ„

### 3. å®Œå¤‡çš„ç±»å‹ç³»ç»Ÿ

- æ”¯æŒ OOP ç±»å‹ç»§æ‰¿
- çµæ´»ä¼˜é›…è¡¨è¾¾è¡Œä¸ºæ ‘ã€æŠ€èƒ½ã€å‰§æƒ…ã€å‰¯æœ¬ç­‰å¤æ‚ GamePlay æ•°æ®
- æ”¯æŒç”Ÿæˆ C#ã€Javaã€Goã€C++ã€Luaã€Pythonã€JavaScriptã€TypeScriptã€Erlangã€Rustã€GDScript ä»£ç 

### 4. å¼ºå¤§çš„æ•°æ®æ ¡éªŒèƒ½åŠ›

- **ref å¼•ç”¨æ£€æŸ¥**ï¼šæ£€æŸ¥é…ç½®è¡¨ä¹‹é—´çš„å¼•ç”¨å…³ç³»
- **path èµ„æºè·¯å¾„æ£€æŸ¥**ï¼šæ£€æŸ¥èµ„æºè·¯å¾„æ˜¯å¦å­˜åœ¨
- **range èŒƒå›´æ£€æŸ¥**ï¼šæ£€æŸ¥æ•°å€¼èŒƒå›´
- **ç±»å‹å®‰å…¨æ£€æŸ¥**ï¼šç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥

### 5. å®Œå–„çš„æœ¬åœ°åŒ–æ”¯æŒ

- é™æ€æ–‡æœ¬å€¼æœ¬åœ°åŒ–
- åŠ¨æ€æ–‡æœ¬å€¼æœ¬åœ°åŒ–
- æ—¶é—´æœ¬åœ°åŒ–
- main-patch å¤šåœ°åŒºç‰ˆæœ¬

### 6. å¼ºå¤§çµæ´»çš„è‡ªå®šä¹‰èƒ½åŠ›

- æ”¯æŒè‡ªå®šä¹‰ä»£ç æ¨¡æ¿
- æ”¯æŒè‡ªå®šä¹‰æ•°æ®æ¨¡æ¿
- é€šç”¨å‹ç”Ÿæˆå’Œç¼“å­˜å·¥å…·
- ä¹Ÿå¯ä»¥ç”¨äºç”Ÿæˆåè®®ã€æ•°æ®åº“ä¹‹ç±»çš„ä»£ç 

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨æ‡’åŠ è½½æ¨¡å¼

å¯¹äºå¤§å‹é¡¹ç›®ï¼Œæ¨èä½¿ç”¨æ‡’åŠ è½½æ¨¡å¼ï¼ŒæŒ‰éœ€åŠ è½½é…ç½®ï¼š

```csharp
// âœ… æ¨èï¼šæ‡’åŠ è½½ï¼ŒæŒ‰éœ€åŠ è½½
var config = ConfigLoader.Instance.Tables.TbItem.Get(itemId);
```

### 2. åˆ›å»ºé…ç½®è¡¨ç®¡ç†å™¨

ä¸ºæ¯ä¸ªé…ç½®è¡¨åˆ›å»ºç®¡ç†å™¨ï¼Œç»Ÿä¸€ç®¡ç†é…ç½®è®¿é—®ï¼š

```csharp
public class ItemConfigMgr : Singleton<ItemConfigMgr>
{
    private TbItem TbItem => ConfigLoader.Instance.Tables.TbItem;
    
    public ItemConfig GetItemConfig(int itemId)
    {
        return TbItem.Get(itemId);
    }
}
```

### 3. ä½¿ç”¨é…ç½®è¡¨éªŒè¯

åœ¨é…ç½®è¡¨å®šä¹‰ä¸­ä½¿ç”¨éªŒè¯ç‰¹æ€§ï¼š

```csharp
// åœ¨ Luban é…ç½®è¡¨ä¸­ä½¿ç”¨éªŒè¯
item_id: int, ref: TbItem;  // å¼•ç”¨æ£€æŸ¥
item_count: int, range: [1, 999];  // èŒƒå›´æ£€æŸ¥
item_path: string, path: "Assets/";  // è·¯å¾„æ£€æŸ¥
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Luban å®˜æ–¹æ–‡æ¡£](https://luban.doc.code-philosophy.com/#/manual/traits)
- [Luban GitHub](https://github.com/focus-creative-games/luban)

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [èµ„æºæ¨¡å—æ–‡æ¡£](./3-1-èµ„æºæ¨¡å—.md) - äº†è§£èµ„æºç®¡ç†
- [æµç¨‹æ¨¡å—æ–‡æ¡£](./3-7-æµç¨‹æ¨¡å—.md) - äº†è§£é…ç½®è¡¨çš„åŠ è½½æµç¨‹
