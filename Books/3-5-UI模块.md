# 3-5. UI æ¨¡å— - UIModule

## ğŸ¨ æ¨¡å—æ¦‚è¿°

ä¸€ä¸ªæ¸¸æˆ 70% éƒ½æ˜¯ UIï¼Œå‰©ä¸‹ 30% æ‰æ˜¯ GamePlayã€‚TEngine UI æ¨¡å—æ˜¯ä¸€å¥—**è½»é‡çº§ã€é«˜å¯æ‹“å±•æ€§**çš„å•†ä¸šåŒ– UI æ¡†æ¶ï¼Œé…åˆäº‹ä»¶æ¨¡å—å®ç° **MVEï¼ˆModel - View - Eventï¼‰äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼Œèƒ½å¤Ÿæé«˜è‡³å°‘ä¸€å€çš„å¼€å‘æ•ˆç‡ã€‚

### âœ¨ æ ¸å¿ƒä¼˜åŠ¿

1. **ğŸš€ è½»é‡çº§è®¾è®¡**
   - UI è„šæœ¬ä¸º**çº¯ C# å®ç°**ï¼Œå®Œå…¨è„±ç¦» Mono çš„ç”Ÿå‘½å‘¨æœŸ
   - ç”± UIModule çš„å¸§æ›´æ–°é©±åŠ¨å¹¶ç®¡ç† UI çš„ç”Ÿå‘½å‘¨æœŸ
   - é›¶ä¾èµ–ï¼Œä¸å¼ºåˆ¶ç»‘å®šä»»ä½•ç¬¬ä¸‰æ–¹ UI æ¡†æ¶
   - æå°çš„å†…å­˜å ç”¨å’Œæ€§èƒ½å¼€é”€

2. **ğŸ”§ æé«˜çš„å¯æ‹“å±•æ€§**
   - **æ¨¡å—åŒ–æ¶æ„**ï¼šUIBase â†’ UIWindow/UIWidget åˆ†å±‚è®¾è®¡
   - **ä»£ç è‡ªåŠ¨ç”Ÿæˆ**ï¼šä¸€é”®ç”Ÿæˆ UI ç»‘å®šä»£ç ï¼Œæå‡å¼€å‘æ•ˆç‡
   - **çµæ´»çš„ç”Ÿå‘½å‘¨æœŸ**ï¼šå¯è‡ªå®šä¹‰ UI çš„åˆ›å»ºã€åˆ·æ–°ã€æ›´æ–°ã€é”€æ¯æµç¨‹
   - **äº‹ä»¶é©±åŠ¨**ï¼šä¸äº‹ä»¶æ¨¡å—æ·±åº¦é›†æˆï¼Œæ”¯æŒ MVE æ¶æ„

3. **ğŸ’¡ å•†ä¸šçº§å¼€å‘æµç¨‹**
   - å®Œæ•´çš„ UI å¼€å‘å·¥ä½œæµ
   - æ”¯æŒåŒæ­¥/å¼‚æ­¥æ‰“å¼€é¢æ¿
   - è‡ªåŠ¨ç®¡ç† UI èµ„æºå¼•ç”¨ï¼ˆä¸èµ„æºæ¨¡å—é›†æˆï¼‰
   - æ”¯æŒ UI å±‚çº§ç®¡ç†å’Œå…¨å±é¢æ¿

4. **ğŸ¯ æ™ºèƒ½èµ„æºç®¡ç†**
   - ä¸èµ„æºæ¨¡å—æ·±åº¦é›†æˆ
   - UI é”€æ¯æ—¶è‡ªåŠ¨é‡Šæ”¾èµ„æºå¼•ç”¨
   - æ”¯æŒ UIWidget åŠ¨æ€åˆ›å»ºå’Œé”€æ¯

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç±»å±‚æ¬¡ç»“æ„

```
UIBase (UIåŸºç±»)
â”œâ”€â”€ UIWindow (UIçª—å£åŸºç±»)
â””â”€â”€ UIWidget (UIç»„ä»¶åŸºç±»)
```

### æ ¸å¿ƒæ¦‚å¿µ

- **UIBase**ï¼šæ‰€æœ‰ UI çš„åŸºç±»ï¼Œæä¾›åŸºç¡€åŠŸèƒ½å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **UIWindow**ï¼šçª—å£çº§ UIï¼Œç”¨äºå…¨å±æˆ–åŠå±é¢æ¿
- **UIWidget**ï¼šç»„ä»¶çº§ UIï¼Œç”¨äºå¯å¤ç”¨çš„ UI ç»„ä»¶

### è®¾è®¡ç†å¿µ

1. **çº¯ C# å®ç°**ï¼šä¸ä¾èµ– MonoBehaviourï¼Œå®Œå…¨ç”±æ¡†æ¶ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
2. **äº‹ä»¶é©±åŠ¨**ï¼šé€šè¿‡äº‹ä»¶ç³»ç»Ÿè§£è€¦ UI é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘
3. **èµ„æºè‡ªåŠ¨åŒ–**ï¼šUI é”€æ¯æ—¶è‡ªåŠ¨æ¸…ç†èµ„æºå¼•ç”¨å’Œäº‹ä»¶ç›‘å¬

---

## ğŸ› ï¸ å¼€å‘å·¥ä½œæµ

### 1. å‰æœŸé…ç½®

#### UI å‘½åè§„èŒƒ

åœ¨ Scene çª—å£ä¸‹å³é”® `ScriptGenerator` èœå•ä¸‹çš„ `About` ç›®å½•å¯ä»¥æŸ¥çœ‹é»˜è®¤ UI å‘½åå‰ç¼€è§„èŒƒï¼š

![image](src/3-5-1.png)

**é»˜è®¤å‘½åè§„èŒƒ**ï¼š
- `m_` å‰ç¼€ï¼šUI æˆå‘˜å˜é‡ï¼ˆå¦‚ `m_btnStart`ï¼‰
- `m_item` å‰ç¼€ï¼šUIWidget ç»„ä»¶èŠ‚ç‚¹ï¼ˆç‰¹æ®ŠèŠ‚ç‚¹ï¼Œä¸ä¼šç»§ç»­å¾€ä¸‹éå†ï¼‰
- `m_go` å‰ç¼€ï¼šGameObject èŠ‚ç‚¹
- `m_rect` å‰ç¼€ï¼šRectTransform èŠ‚ç‚¹

> **é‡è¦æç¤º**ï¼š`m_item` èŠ‚ç‚¹ä¸ºç‰¹æ®ŠèŠ‚ç‚¹ï¼Œè¡¨ç¤ºæ˜¯ UI ä¸‹çš„ UIWidget ç»„ä»¶ï¼Œä¸ä¼šç»§ç»­å¾€ä¸‹éå†ç”Ÿæˆ UI ä»£ç ã€‚è‹¥éœ€è¦è¿™ä¸ª UIWidget ç»„ä»¶çš„ä»£ç ï¼Œåˆ™åœ¨ `m_item` èŠ‚ç‚¹å³é”®ç”Ÿæˆè¯¥ç»„ä»¶çš„ UI è„šæœ¬ã€‚

#### è‡ªå®šä¹‰é…ç½®

æœ‰è‡ªå®šä¹‰éœ€æ±‚å¯ä»¥åœ¨ `TEngineSetting` ä¸‹è¿›è¡Œè‡ªå®šä¹‰ï¼š

![image](src/3-5-2.png)

### 2. UI ç¼–æ’

éµå®ˆå‰æœŸé»˜è®¤é…ç½®æˆ–è€…è‡ªå®šä¹‰é…ç½®è¿›è¡Œ UI ç¼–æ’ï¼š

![image](src/3-5-3.png)

### 3. ä»£ç ç”Ÿæˆ

åœ¨ UI çš„æ ¹èŠ‚ç‚¹å³é”® `ScriptGenerator` ç”Ÿæˆ UI ä»£ç åˆ°å‰ªè´´æ¿ä¸Šï¼š

![image](src/3-5-4.png)

> **æç¤º**ï¼šä½¿ç”¨ UniTask çš„ç”Ÿæˆä»£ç å¯ä»¥åšå¼‚æ­¥äº‹ä»¶æµé©±åŠ¨çš„ UIã€‚

### 4. åˆ›å»º UI è„šæœ¬

è‡ªè¡Œåˆ›å»º UI è„šæœ¬åˆ°éœ€è¦çš„ç›®å½•ä¸‹å¹¶å¤åˆ¶ç”Ÿæˆçš„ UI ä»£ç ã€‚

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç¤ºä¾‹ï¼šæ‰“å¼€ UI é¢æ¿

```csharp
// åŒæ­¥æ‰“å¼€é¢æ¿
GameModule.UI.ShowUI<GameMainUI>(userData);

// å¼‚æ­¥æ‰“å¼€é¢æ¿ï¼ˆæ¨èï¼‰
await GameModule.UI.ShowUIAsync<GameMainUI>(userData);
```

### å®Œæ•´ç¤ºä¾‹ï¼šUIWindow

```csharp
namespace GameLogic
{
    /// <summary>
    /// BattleMainUI é¢æ¿
    /// <remarks>
    /// UIWindow éœ€è¦æ ‡è®° Window ç‰¹æ€§ï¼š
    /// - UILayerï¼šUI å±‚çº§ï¼ˆå¯ä»¥è‡ªè¡Œå®šä¹‰ï¼‰
    /// - fullScreenï¼šæ˜¯å¦ä¸ºå…¨å±é¢æ¿ï¼ˆå…¨å±é¢æ¿ä¼šåœæ­¢å’Œéšè—è¿™ä¸ªé¢æ¿å †æ ˆåé¢çš„é¢æ¿ï¼‰
    /// </remarks>
    /// </summary>
    [Window(UILayer.Bottom, fullScreen: true)]
    class BattleMainUI : UIWindow
    {
        private TouchMove m_touchView;
        
        #region è„šæœ¬å·¥å…·ç”Ÿæˆçš„ä»£ç 
        private RectTransform m_rectContainer;
        private GameObject m_itemTouch;
        private Button m_btnLeaveBattle;
        private GameObject m_goTopInfo;
        private Button m_btnPause;
        
        public override void ScriptGenerator()
        {
            m_rectContainer = FindChildComponent<RectTransform>("m_rectContainer");
            m_itemTouch = FindChild("m_rectContainer/m_itemTouch").gameObject;
            m_btnLeaveBattle = FindChildComponent<Button>("m_btnLeaveBattle");
            m_goTopInfo = FindChild("m_goTopInfo").gameObject;
            m_btnPause = FindChildComponent<Button>("m_goTopInfo/m_btnPause");
            
            m_btnLeaveBattle.onClick.AddListener(OnClickLeaveBattleBtn);
            m_btnPause.onClick.AddListener(OnClickPauseBtn);
        }
        #endregion

        #region äº‹ä»¶å¤„ç†

        private void OnClickPauseBtn()
        {
            BattleSys.Instance.Pause = !BattleSys.Instance.Pause;
        }

        private void OnClickLeaveBattleBtn()
        {
            BattleSys.Instance.StopBattle(isBattleEnd: false, isWin: false);
        }
        
        #endregion

        /// <summary>
        /// æ³¨å†Œäº‹ä»¶
        /// é€šè¿‡ AddUIEvent æ³¨å†Œçš„äº‹ä»¶ä¼šè‡ªåŠ¨ç»‘å®š UI ç”Ÿå‘½å‘¨æœŸï¼Œé¢æ¿é”€æ¯æ—¶è‡ªåŠ¨ç§»é™¤ç›‘å¬
        /// </summary>
        public override void RegisterEvent()
        {
            AddUIEvent(ActorLogicEventDefined.OnMainPlayerBagDataChange, RefreshUI);
        }

        /// <summary>
        /// ç»‘å®š UI æˆå‘˜å±æ€§
        /// ç‰¹æ®Šçš„ m_item èŠ‚ç‚¹éœ€è¦åˆ›å»ºå¯¹åº”çš„ UIWidget è„šæœ¬
        /// </summary>
        public override void BindMemberProperty()
        {
            // æ–¹å¼1ï¼šé€šè¿‡ GameObject åˆ›å»º Widget
            m_touchView = CreateWidget<TouchMove>(m_itemTouch);
            
            // æ–¹å¼2ï¼šé€šè¿‡è·¯å¾„åˆ›å»º Widget
            // m_touchView = CreateWidget<TouchMove>("m_rectContainer/m_itemTouch");
            
            // æ–¹å¼3ï¼šé€šè¿‡èµ„æºè·¯å¾„å¼‚æ­¥åˆ›å»º Widget
            // m_touchView = await CreateWidgetByPathAsync<TouchMove>(m_rectContainer, "UI/TouchMove");
        }

        /// <summary>
        /// UI åˆ·æ–°
        /// </summary>
        public override void OnRefresh()
        {
            // åˆ·æ–° UI æ•°æ®
        }
    }
}
```

### UIWidget ç¤ºä¾‹

```csharp
namespace GameLogic
{
    /// <summary>
    /// ç§»åŠ¨æ“ä½œ UIWidget
    /// </summary>
    class TouchMove : UIWidget, IUICtrlMove
    {
        public override void BindMemberProperty()
        {
            // ç»‘å®š Widget æˆå‘˜
        }

        /// <summary>
        /// UI æ›´æ–°
        /// æ³¨æ„ï¼šåªæœ‰åœ¨é‡å†™äº†æ­¤æ–¹æ³•æ‰ä¼šé©±åŠ¨è¿™ä¸ª Widget æˆ–é¢æ¿çš„ Update
        /// </summary>
        public override void OnUpdate()
        {
            TProfiler.BeginSample("CheckMoveTouchFinger");
            CheckMoveTouchFinger();
            TProfiler.EndSample();

            TProfiler.BeginSample("UpdateTouchMovePos");
            UpdateTouchMovePos();
            TProfiler.EndSample();

            TProfiler.BeginSample("UpdateKeyMove");
            UpdateKeyMove();
            TProfiler.EndSample();
        }
    }
}
```

---

## ğŸ¨ UIWidget è®¾è®¡ä¸æ‹“å±•

### è®¾è®¡ç†å¿µ

**UIWidget** æ˜¯ TEngine UI æ¡†æ¶ä¸­çš„æ ¸å¿ƒç»„ä»¶è®¾è®¡ï¼Œé‡‡ç”¨**ç»„åˆä¼˜äºç»§æ‰¿**çš„è®¾è®¡ç†å¿µï¼Œé€šè¿‡ Widget çš„ç»„åˆæ¥æ„å»ºå¤æ‚çš„ UI ç•Œé¢ã€‚

#### æ ¸å¿ƒä¼˜åŠ¿

1. **ğŸ”§ é«˜åº¦å¯å¤ç”¨**
   - Widget å¯ä»¥åœ¨å¤šä¸ª Window ä¸­å¤ç”¨
   - ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - å¯ç‹¬ç«‹æµ‹è¯•å’Œç»´æŠ¤

2. **ğŸ“¦ æ¨¡å—åŒ–è®¾è®¡**
   - æ¯ä¸ª Widget èŒè´£å•ä¸€
   - é€šè¿‡ç»„åˆæ„å»ºå¤æ‚ç•Œé¢
   - æ˜“äºæ‰©å±•å’Œç»´æŠ¤

3. **ğŸ¯ çµæ´»çš„ç”Ÿå‘½å‘¨æœŸ**
   - æ”¯æŒåŠ¨æ€åˆ›å»ºå’Œé”€æ¯
   - æ”¯æŒåµŒå¥— Widget
   - è‡ªåŠ¨ç®¡ç†èµ„æºå¼•ç”¨

### å±‚æ¬¡ç»“æ„è®¾è®¡

TEngine UI æ¡†æ¶æ”¯æŒå¤šå±‚æ¬¡çš„ Widget åµŒå¥—ç»“æ„ï¼š

```
UIWindow (çª—å£)
  â”œâ”€â”€ UIPage (é¡µé¢ Widget)
  â”‚   â”œâ”€â”€ TabButtonWidget (é¡µç­¾æŒ‰é’® Widget)
  â”‚   â”œâ”€â”€ ContentWidget (å†…å®¹ Widget)
  â”‚   â”‚   â””â”€â”€ ItemWidget (åˆ—è¡¨é¡¹ Widget)
  â”‚   â””â”€â”€ ...
  â””â”€â”€ ...
```

### å®Œæ•´ç¤ºä¾‹ï¼šèƒŒåŒ…ç•Œé¢

ä¸‹é¢é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„èƒŒåŒ…ç•Œé¢ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ UIWidget æ„å»ºå¤æ‚çš„ UI ç•Œé¢ã€‚

#### ç•Œé¢ç»“æ„å›¾

```
BagWindow (UIWindow - èƒŒåŒ…çª—å£)
â”‚
â”œâ”€â”€ m_goTopBar (é¡¶éƒ¨æ )
â”‚   â”œâ”€â”€ m_btnClose (å…³é—­æŒ‰é’®)
â”‚   â””â”€â”€ m_textTitle (æ ‡é¢˜æ–‡æœ¬)
â”‚
â”œâ”€â”€ m_goTabBar (é¡µç­¾æ )
â”‚   â”œâ”€â”€ m_itemTabWeapon (TabButtonWidget - æ­¦å™¨é¡µç­¾)
â”‚   â”œâ”€â”€ m_itemTabArmor (TabButtonWidget - é˜²å…·é¡µç­¾)
â”‚   â”œâ”€â”€ m_itemTabConsumable (TabButtonWidget - æ¶ˆè€—å“é¡µç­¾)
â”‚   â””â”€â”€ m_itemTabMaterial (TabButtonWidget - ææ–™é¡µç­¾)
â”‚
â””â”€â”€ m_goContent (å†…å®¹åŒºåŸŸ)
    â””â”€â”€ m_itemPageContainer (é¡µé¢å®¹å™¨)
        â”œâ”€â”€ WeaponPage (UIPage Widget - æ­¦å™¨é¡µé¢)
        â”‚   â””â”€â”€ m_itemScrollView (æ»šåŠ¨è§†å›¾)
        â”‚       â””â”€â”€ m_itemList (åˆ—è¡¨å®¹å™¨)
        â”‚           â”œâ”€â”€ BagItemWidget (Item Widget - èƒŒåŒ…ç‰©å“)
        â”‚           â”œâ”€â”€ BagItemWidget
        â”‚           â””â”€â”€ ...
        â”œâ”€â”€ ArmorPage (UIPage Widget - é˜²å…·é¡µé¢)
        â”œâ”€â”€ ConsumablePage (UIPage Widget - æ¶ˆè€—å“é¡µé¢)
        â””â”€â”€ MaterialPage (UIPage Widget - ææ–™é¡µé¢)
```

#### 1. BagWindow - èƒŒåŒ…çª—å£ï¼ˆUIWindowï¼‰

```csharp
namespace GameLogic
{
    /// <summary>
    /// èƒŒåŒ…çª—å£
    /// </summary>
    [Window(UILayer.Normal)]
    class BagWindow : UIWindow
    {
        // é¡µç­¾æŒ‰é’® Widget åˆ—è¡¨
        private List<TabButtonWidget> _tabButtons = new List<TabButtonWidget>();
        
        // é¡µé¢ Widget åˆ—è¡¨
        private List<UIPage> _pages = new List<UIPage>();
        
        // å½“å‰é€‰ä¸­çš„é¡µç­¾ç´¢å¼•
        private int _currentTabIndex = 0;
        
        #region è„šæœ¬å·¥å…·ç”Ÿæˆçš„ä»£ç 
        private GameObject m_goTopBar;
        private Button m_btnClose;
        private Text m_textTitle;
        private GameObject m_goTabBar;
        private GameObject m_itemTabWeapon;
        private GameObject m_itemTabArmor;
        private GameObject m_itemTabConsumable;
        private GameObject m_itemTabMaterial;
        private GameObject m_goContent;
        private Transform m_itemPageContainer;
        
        public override void ScriptGenerator()
        {
            m_goTopBar = FindChild("m_goTopBar").gameObject;
            m_btnClose = FindChildComponent<Button>("m_goTopBar/m_btnClose");
            m_textTitle = FindChildComponent<Text>("m_goTopBar/m_textTitle");
            m_goTabBar = FindChild("m_goTabBar").gameObject;
            m_itemTabWeapon = FindChild("m_goTabBar/m_itemTabWeapon").gameObject;
            m_itemTabArmor = FindChild("m_goTabBar/m_itemTabArmor").gameObject;
            m_itemTabConsumable = FindChild("m_goTabBar/m_itemTabConsumable").gameObject;
            m_itemTabMaterial = FindChild("m_goTabBar/m_itemTabMaterial").gameObject;
            m_goContent = FindChild("m_goContent").gameObject;
            m_itemPageContainer = FindChild("m_goContent/m_itemPageContainer");
            
            m_btnClose.onClick.AddListener(OnClickCloseBtn);
        }
        #endregion

        public override void BindMemberProperty()
        {
            // åˆ›å»ºé¡µç­¾æŒ‰é’® Widget
            _tabButtons.Add(CreateWidget<TabButtonWidget>(m_itemTabWeapon));
            _tabButtons.Add(CreateWidget<TabButtonWidget>(m_itemTabArmor));
            _tabButtons.Add(CreateWidget<TabButtonWidget>(m_itemTabConsumable));
            _tabButtons.Add(CreateWidget<TabButtonWidget>(m_itemTabMaterial));
            
            // è®¾ç½®é¡µç­¾æŒ‰é’®æ•°æ®
            _tabButtons[0].SetData("æ­¦å™¨", 0, OnTabClick);
            _tabButtons[1].SetData("é˜²å…·", 1, OnTabClick);
            _tabButtons[2].SetData("æ¶ˆè€—å“", 2, OnTabClick);
            _tabButtons[3].SetData("ææ–™", 3, OnTabClick);
            
            // åˆ›å»ºé¡µé¢ Widget
            _pages.Add(CreateWidgetByType<WeaponPage>(m_itemPageContainer));
            _pages.Add(CreateWidgetByType<ArmorPage>(m_itemPageContainer));
            _pages.Add(CreateWidgetByType<ConsumablePage>(m_itemPageContainer));
            _pages.Add(CreateWidgetByType<MaterialPage>(m_itemPageContainer));
            
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªé¡µé¢
            SwitchPage(0);
        }

        public override void RegisterEvent()
        {
            // ç›‘å¬èƒŒåŒ…æ•°æ®å˜åŒ–
            AddUIEvent(BagEventDefined.OnBagDataChange, OnBagDataChange);
        }

        private void OnClickCloseBtn()
        {
            GameModule.UI.CloseWindow(this);
        }

        private void OnTabClick(int tabIndex)
        {
            if (_currentTabIndex == tabIndex) return;
            
            // æ›´æ–°é¡µç­¾çŠ¶æ€
            _tabButtons[_currentTabIndex].SetSelected(false);
            _tabButtons[tabIndex].SetSelected(true);
            
            // åˆ‡æ¢é¡µé¢
            SwitchPage(tabIndex);
            
            _currentTabIndex = tabIndex;
        }

        private void SwitchPage(int pageIndex)
        {
            // éšè—æ‰€æœ‰é¡µé¢
            for (int i = 0; i < _pages.Count; i++)
            {
                _pages[i].Visible = (i == pageIndex);
            }
        }

        private void OnBagDataChange()
        {
            // åˆ·æ–°å½“å‰é¡µé¢
            if (_currentTabIndex < _pages.Count)
            {
                _pages[_currentTabIndex].Refresh();
            }
        }
    }
}
```

#### 2. TabButtonWidget - é¡µç­¾æŒ‰é’® Widget

```csharp
namespace GameLogic
{
    /// <summary>
    /// é¡µç­¾æŒ‰é’® Widget
    /// å¯å¤ç”¨çš„é¡µç­¾æŒ‰é’®ç»„ä»¶
    /// </summary>
    class TabButtonWidget : UIWidget
    {
        private int _tabIndex;
        private Action<int> _onClick;
        
        #region è„šæœ¬å·¥å…·ç”Ÿæˆçš„ä»£ç 
        private Button m_btnTab;
        private Text m_textTabName;
        private GameObject m_goSelected;
        
        public override void ScriptGenerator()
        {
            m_btnTab = FindChildComponent<Button>("m_btnTab");
            m_textTabName = FindChildComponent<Text>("m_btnTab/m_textTabName");
            m_goSelected = FindChild("m_btnTab/m_goSelected").gameObject;
            
            m_btnTab.onClick.AddListener(OnClickTab);
        }
        #endregion

        /// <summary>
        /// è®¾ç½®é¡µç­¾æ•°æ®
        /// </summary>
        public void SetData(string tabName, int tabIndex, Action<int> onClick)
        {
            m_textTabName.text = tabName;
            _tabIndex = tabIndex;
            _onClick = onClick;
        }

        /// <summary>
        /// è®¾ç½®é€‰ä¸­çŠ¶æ€
        /// </summary>
        public void SetSelected(bool selected)
        {
            m_goSelected.SetActive(selected);
            // å¯ä»¥æ·»åŠ æ›´å¤šé€‰ä¸­çŠ¶æ€çš„è§†è§‰æ•ˆæœ
        }

        private void OnClickTab()
        {
            _onClick?.Invoke(_tabIndex);
        }
    }
}
```

#### 3. UIPage - é¡µé¢åŸºç±» Widget

```csharp
namespace GameLogic
{
    /// <summary>
    /// é¡µé¢åŸºç±» Widget
    /// æ‰€æœ‰é¡µé¢çš„åŸºç±»ï¼Œæä¾›é€šç”¨çš„é¡µé¢åŠŸèƒ½
    /// </summary>
    abstract class UIPage : UIWidget
    {
        /// <summary>
        /// åˆ·æ–°é¡µé¢æ•°æ®
        /// </summary>
        public virtual void Refresh()
        {
            // å­ç±»å®ç°å…·ä½“çš„åˆ·æ–°é€»è¾‘
        }

        /// <summary>
        /// é¡µé¢æ˜¾ç¤ºæ—¶è°ƒç”¨
        /// </summary>
        public override void OnSetVisible(bool visible)
        {
            base.OnSetVisible(visible);
            if (visible)
            {
                Refresh();
            }
        }
    }
}
```

#### 4. WeaponPage - æ­¦å™¨é¡µé¢ Widget

```csharp
namespace GameLogic
{
    /// <summary>
    /// æ­¦å™¨é¡µé¢ Widget
    /// å±•ç¤ºæ­¦å™¨ç±»å‹çš„èƒŒåŒ…ç‰©å“
    /// </summary>
    class WeaponPage : UIPage
    {
        // ç‰©å“ Widget åˆ—è¡¨
        private List<BagItemWidget> _itemWidgets = new List<BagItemWidget>();
        
        #region è„šæœ¬å·¥å…·ç”Ÿæˆçš„ä»£ç 
        private ScrollRect m_itemScrollView;
        private Transform m_itemList;
        
        public override void ScriptGenerator()
        {
            m_itemScrollView = FindChildComponent<ScrollRect>("m_itemScrollView");
            m_itemList = FindChild("m_itemScrollView/Viewport/Content/m_itemList");
        }
        #endregion

        public override void Refresh()
        {
            // è·å–æ­¦å™¨ç±»å‹çš„ç‰©å“æ•°æ®
            var weaponItems = BagMgr.Instance.GetItemsByType(ItemType.Weapon);
            
            // è°ƒæ•´ç‰©å“ Widget æ•°é‡
            AdjustIconNum(_itemWidgets, weaponItems.Count, m_itemList);
            
            // æ›´æ–°æ¯ä¸ªç‰©å“ Widget çš„æ•°æ®
            for (int i = 0; i < weaponItems.Count; i++)
            {
                _itemWidgets[i].SetData(weaponItems[i]);
            }
        }
    }
}
```

#### 5. BagItemWidget - èƒŒåŒ…ç‰©å“ Widget

```csharp
namespace GameLogic
{
    /// <summary>
    /// èƒŒåŒ…ç‰©å“ Widget
    /// å¯å¤ç”¨çš„ç‰©å“å±•ç¤ºç»„ä»¶
    /// </summary>
    class BagItemWidget : UIWidget
    {
        private ItemData _itemData;
        
        #region è„šæœ¬å·¥å…·ç”Ÿæˆçš„ä»£ç 
        private Image m_imgIcon;
        private Text m_textName;
        private Text m_textCount;
        private GameObject m_goQuality;
        private Button m_btnItem;
        
        public override void ScriptGenerator()
        {
            m_imgIcon = FindChildComponent<Image>("m_imgIcon");
            m_textName = FindChildComponent<Text>("m_textName");
            m_textCount = FindChildComponent<Text>("m_textCount");
            m_goQuality = FindChild("m_goQuality").gameObject;
            m_btnItem = FindChildComponent<Button>("m_btnItem");
            
            m_btnItem.onClick.AddListener(OnClickItem);
        }
        #endregion

        /// <summary>
        /// è®¾ç½®ç‰©å“æ•°æ®
        /// </summary>
        public void SetData(ItemData itemData)
        {
            _itemData = itemData;
            
            if (itemData == null)
            {
                Visible = false;
                return;
            }
            
            Visible = true;
            
            // è®¾ç½®ç‰©å“å›¾æ ‡ï¼ˆä½¿ç”¨ SetSprite è‡ªåŠ¨ç®¡ç†èµ„æºï¼‰
            m_imgIcon.SetSprite($"UI/Icon/Item/{itemData.IconName}");
            
            // è®¾ç½®ç‰©å“åç§°
            m_textName.text = itemData.Name;
            
            // è®¾ç½®æ•°é‡
            m_textCount.text = itemData.Count > 1 ? itemData.Count.ToString() : "";
            
            // è®¾ç½®å“è´¨æ˜¾ç¤º
            SetQuality(itemData.Quality);
        }

        /// <summary>
        /// è®¾ç½®å“è´¨æ˜¾ç¤º
        /// </summary>
        private void SetQuality(int quality)
        {
            // æ ¹æ®å“è´¨æ˜¾ç¤ºä¸åŒçš„è¾¹æ¡†é¢œè‰²ç­‰
            // m_goQuality.GetComponent<Image>().color = GetQualityColor(quality);
        }

        private void OnClickItem()
        {
            if (_itemData != null)
            {
                // å‘é€ç‰©å“ç‚¹å‡»äº‹ä»¶
                GameEvent.Send(BagEventDefined.OnItemClick, _itemData);
            }
        }
    }
}
```

### UIWidget æ‹“å±•åœºæ™¯

#### åœºæ™¯ 1ï¼šåˆ—è¡¨é¡¹ Widget

åˆ—è¡¨é¡¹æ˜¯ UIWidget æœ€å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼š

```csharp
// èŠå¤©æ¶ˆæ¯åˆ—è¡¨é¡¹
class ChatMessageWidget : UIWidget
{
    public void SetData(ChatMessageData data) { }
}

// æ’è¡Œæ¦œåˆ—è¡¨é¡¹
class RankItemWidget : UIWidget
{
    public void SetData(RankData data) { }
}

// å•†åº—å•†å“åˆ—è¡¨é¡¹
class ShopItemWidget : UIWidget
{
    public void SetData(ShopItemData data) { }
}
```

#### åœºæ™¯ 2ï¼šåŠŸèƒ½æ¨¡å— Widget

å°†å¤æ‚åŠŸèƒ½å°è£…æˆ Widgetï¼š

```csharp
// è§’è‰²å±æ€§é¢æ¿ Widget
class CharacterAttributeWidget : UIWidget
{
    public void RefreshAttribute(CharacterData data) { }
}

// æŠ€èƒ½æ ‘ Widget
class SkillTreeWidget : UIWidget
{
    public void RefreshSkillTree(SkillTreeData data) { }
}
```

#### åœºæ™¯ 3ï¼šåŠ¨æ€å†…å®¹ Widget

æ”¯æŒåŠ¨æ€åˆ›å»ºå’Œé”€æ¯çš„ Widgetï¼š

```csharp
// åŠ¨æ€åˆ›å»ºæç¤º Widget
class TipWidget : UIWidget
{
    public static void ShowTip(string message, Vector2 position)
    {
        var tip = CreateWidgetByType<TipWidget>(UIModule.UIRoot);
        tip.SetMessage(message);
        tip.SetPosition(position);
        
        // 3ç§’åè‡ªåŠ¨é”€æ¯
        UniTask.Delay(3000).ContinueWith(() => {
            tip.OnDestroy();
            Object.Destroy(tip.gameObject);
        }).Forget();
    }
}
```

### UIWidget è®¾è®¡æ¨¡å¼

#### æ¨¡å¼ 1ï¼šæ•°æ®é©±åŠ¨

```csharp
// Widget é€šè¿‡ SetData æ–¹æ³•æ¥æ”¶æ•°æ®ï¼Œè‡ªåŠ¨æ›´æ–° UI
class ItemWidget : UIWidget
{
    public void SetData(ItemData data)
    {
        // æ ¹æ®æ•°æ®è‡ªåŠ¨æ›´æ–° UI
        UpdateUI(data);
    }
}
```

#### æ¨¡å¼ 2ï¼šäº‹ä»¶é©±åŠ¨

```csharp
// Widget é€šè¿‡äº‹ä»¶ç³»ç»Ÿä¸å¤–éƒ¨é€šä¿¡
class ItemWidget : UIWidget
{
    public override void RegisterEvent()
    {
        // ç›‘å¬ç‰©å“æ•°æ®å˜åŒ–
        AddUIEvent(ItemEventDefined.OnItemUpdate, OnItemUpdate);
    }
    
    private void OnItemUpdate(ItemData data)
    {
        if (data.ItemId == _itemData.ItemId)
        {
            SetData(data);
        }
    }
}
```

#### æ¨¡å¼ 3ï¼šç»„åˆæ¨¡å¼

```csharp
// é€šè¿‡ç»„åˆå¤šä¸ª Widget æ„å»ºå¤æ‚ç•Œé¢
class ComplexPage : UIPage
{
    private HeaderWidget _header;
    private ContentWidget _content;
    private FooterWidget _footer;
    
    public override void BindMemberProperty()
    {
        _header = CreateWidget<HeaderWidget>("m_itemHeader");
        _content = CreateWidget<ContentWidget>("m_itemContent");
        _footer = CreateWidget<FooterWidget>("m_itemFooter");
    }
}
```

### UIWidget æœ€ä½³å®è·µ

#### 1. å•ä¸€èŒè´£åŸåˆ™

æ¯ä¸ª Widget åº”è¯¥åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„åŠŸèƒ½ï¼š

```csharp
// âœ… æ¨èï¼šèŒè´£å•ä¸€
class ItemIconWidget : UIWidget
{
    // åªè´Ÿè´£æ˜¾ç¤ºç‰©å“å›¾æ ‡
}

// âŒ ä¸æ¨èï¼šèŒè´£è¿‡å¤š
class ItemWidget : UIWidget
{
    // åŒæ—¶è´Ÿè´£æ˜¾ç¤ºå›¾æ ‡ã€åç§°ã€æ•°é‡ã€å“è´¨ã€æ“ä½œæŒ‰é’®ç­‰
}
```

#### 2. æ•°æ®ä¸è§†å›¾åˆ†ç¦»

Widget åªè´Ÿè´£è§†å›¾å±•ç¤ºï¼Œæ•°æ®ç”±å¤–éƒ¨ä¼ å…¥ï¼š

```csharp
// âœ… æ¨èï¼šæ•°æ®ä¸è§†å›¾åˆ†ç¦»
class ItemWidget : UIWidget
{
    public void SetData(ItemData data)
    {
        // åªè´Ÿè´£æ ¹æ®æ•°æ®æ›´æ–°è§†å›¾
    }
}

// âŒ ä¸æ¨èï¼šWidget ç›´æ¥è®¿é—®æ•°æ®ç®¡ç†å™¨
class ItemWidget : UIWidget
{
    public void Refresh()
    {
        var data = ItemMgr.Instance.GetItem(_itemId); // ä¸æ¨è
    }
}
```

#### 3. ä½¿ç”¨ SetData æ¨¡å¼

ç»Ÿä¸€ä½¿ç”¨ SetData æ–¹æ³•æ›´æ–° Widgetï¼š

```csharp
// âœ… æ¨èï¼šç»Ÿä¸€çš„ SetData æ¥å£
class ItemWidget : UIWidget
{
    public void SetData(ItemData data) { }
}

// âŒ ä¸æ¨èï¼šå¤šä¸ªæ›´æ–°æ–¹æ³•
class ItemWidget : UIWidget
{
    public void SetIcon(string icon) { }
    public void SetName(string name) { }
    public void SetCount(int count) { }
}
```

#### 4. åˆç†ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸ

æ ¹æ®éœ€æ±‚é‡å†™ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼š

```csharp
class ItemWidget : UIWidget
{
    // åªåœ¨éœ€è¦æ—¶é‡å†™ OnUpdate
    public override void OnUpdate()
    {
        // å®æ—¶æ›´æ–°å€’è®¡æ—¶ç­‰
        UpdateCountdown();
    }
    
    // åœ¨ OnSetVisible ä¸­å¤„ç†æ˜¾ç¤º/éšè—é€»è¾‘
    public override void OnSetVisible(bool visible)
    {
        base.OnSetVisible(visible);
        if (visible)
        {
            PlayShowAnimation();
        }
    }
}
```

---

## ğŸ”§ æ ¸å¿ƒ API

### UIWindow ç”Ÿå‘½å‘¨æœŸ

```csharp
/// <summary>
/// UI åˆ›å»ºæ—¶è°ƒç”¨ï¼ˆèµ„æºåŠ è½½å®Œæˆåï¼‰
/// </summary>
protected virtual void OnCreate() { }

/// <summary>
/// UI åˆ·æ–°æ—¶è°ƒç”¨ï¼ˆæ¯æ¬¡æ‰“å¼€æ—¶ï¼‰
/// </summary>
protected virtual void OnRefresh() { }

/// <summary>
/// UI æ›´æ–°æ—¶è°ƒç”¨ï¼ˆæ¯å¸§ï¼Œéœ€è¦é‡å†™æ‰ä¼šè°ƒç”¨ï¼‰
/// </summary>
protected virtual void OnUpdate() { }

/// <summary>
/// UI é”€æ¯æ—¶è°ƒç”¨
/// </summary>
protected virtual void OnDestroy() { }
```

### UIWidget åˆ›å»ºæ–¹å¼

```csharp
// æ–¹å¼1ï¼šé€šè¿‡ GameObject åˆ›å»ºï¼ˆæ¨èï¼Œèµ„æºå·²å­˜åœ¨ï¼‰
T CreateWidget<T>(GameObject goRoot, bool visible = true) where T : UIWidget, new();

// æ–¹å¼2ï¼šé€šè¿‡è·¯å¾„åˆ›å»ºï¼ˆåŒæ­¥ï¼‰
T CreateWidgetByPath<T>(Transform parentTrans, string assetLocation, bool visible = true) where T : UIWidget, new();

// æ–¹å¼3ï¼šé€šè¿‡è·¯å¾„åˆ›å»ºï¼ˆå¼‚æ­¥ï¼Œæ¨èï¼‰
UniTask<T> CreateWidgetByPathAsync<T>(Transform parentTrans, string assetLocation, bool visible = true) where T : UIWidget, new();

// æ–¹å¼4ï¼šé€šè¿‡ç±»å‹åˆ›å»ºï¼ˆæ ¹æ®ç±»å‹ååŠ è½½èµ„æºï¼‰
T CreateWidgetByType<T>(Transform parentTrans, bool visible = true) where T : UIWidget, new();
```

### äº‹ä»¶æ³¨å†Œ

```csharp
// æ³¨å†Œäº‹ä»¶ï¼ˆè‡ªåŠ¨ç»‘å®š UI ç”Ÿå‘½å‘¨æœŸï¼‰
AddUIEvent(int eventType, Action handler);
AddUIEvent<T>(int eventType, Action<T> handler);
AddUIEvent<T, U>(int eventType, Action<T, U> handler);

// ç§»é™¤æ‰€æœ‰äº‹ä»¶ï¼ˆé€šå¸¸åœ¨ OnDestroy ä¸­è‡ªåŠ¨è°ƒç”¨ï¼‰
RemoveAllUIEvent();
```

### UI æŸ¥æ‰¾æ–¹æ³•

```csharp
// æŸ¥æ‰¾å­èŠ‚ç‚¹
Transform FindChild(string path);
Transform FindChild(Transform trans, string path);

// æŸ¥æ‰¾ç»„ä»¶
T FindChildComponent<T>(string path) where T : Component;
T FindChildComponent<T>(Transform trans, string path) where T : Component;
```

---

## ğŸ¯ é«˜çº§ç‰¹æ€§

### 1. UI å±‚çº§ç®¡ç†

UI é¢æ¿éœ€è¦æ ‡è®° `Window` ç‰¹æ€§ï¼Œä»¥æ ‡è¯†å±‚çº§å’Œæ˜¯å¦å…¨å±ï¼š

```csharp
[Window(UILayer.Bottom, fullScreen: true)]
class BattleMainUI : UIWindow
{
    // å…¨å±é¢æ¿ä¼šæŠŠä¸‹å±‚é¢æ¿çš„ Visible è®¾ç½®ä¸º false
}
```

![image](src/3-5-5.png)

### 2. äº‹ä»¶ç”Ÿå‘½å‘¨æœŸç»‘å®š

é€šè¿‡ `AddUIEvent` æ³¨å†Œçš„äº‹ä»¶ä¼šè‡ªåŠ¨ç»‘å®š UI ç”Ÿå‘½å‘¨æœŸï¼š

- âœ… UI åˆ›å»ºæ—¶è‡ªåŠ¨æ³¨å†Œäº‹ä»¶
- âœ… UI é”€æ¯æ—¶è‡ªåŠ¨ç§»é™¤äº‹ä»¶ç›‘å¬
- âœ… æ— éœ€æ‰‹åŠ¨ç®¡ç†äº‹ä»¶ç”Ÿå‘½å‘¨æœŸ

```csharp
public override void RegisterEvent()
{
    // é¢æ¿é”€æ¯æ—¶è‡ªåŠ¨ç§»é™¤ç›‘å¬ï¼Œæ— éœ€æ‰‹åŠ¨ RemoveEventListener
    AddUIEvent(ActorLogicEventDefined.OnMainPlayerBagDataChange, RefreshUI);
}
```

### 3. èµ„æºè‡ªåŠ¨ç®¡ç†

UI æ¨¡å—ä¸èµ„æºæ¨¡å—æ·±åº¦é›†æˆï¼š

- âœ… UI åŠ è½½æ—¶è‡ªåŠ¨ç®¡ç†èµ„æºå¼•ç”¨
- âœ… UI é”€æ¯æ—¶è‡ªåŠ¨é‡Šæ”¾èµ„æº
- âœ… æ”¯æŒ UIWidget åŠ¨æ€åˆ›å»ºå’Œé”€æ¯

### 4. ä¾èµ–æ³¨å…¥æ”¯æŒ

UI æ¨¡å—æ”¯æŒä¾èµ–æ³¨å…¥ï¼š

```csharp
// è®¾ç½®ä¾èµ–æ³¨å…¥å™¨
UIBase.Injector = (uiBase) => {
    // æ³¨å…¥ä¾èµ–
    if (uiBase is BattleMainUI battleUI)
    {
        battleUI.SetDependency(someService);
    }
};
```

### 5. æ¡ä»¶æ›´æ–°

UI çš„ Update æ–¹æ³•åªæœ‰åœ¨é‡å†™æ—¶æ‰ä¼šè¢«è°ƒç”¨ï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ï¼š

```csharp
// åªæœ‰é‡å†™äº† OnUpdate æ‰ä¼šæ¯å¸§è°ƒç”¨
public override void OnUpdate()
{
    // æ›´æ–°é€»è¾‘
}
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥åŠ è½½

```csharp
// âœ… æ¨èï¼šå¼‚æ­¥åŠ è½½ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
await GameModule.UI.ShowUIAsync<GameMainUI>(userData);

// âŒ ä¸æ¨èï¼šåŒæ­¥åŠ è½½ï¼Œå¯èƒ½é€ æˆå¡é¡¿
GameModule.UI.ShowUI<GameMainUI>(userData);
```

### 2. ä½¿ç”¨ AddUIEvent æ³¨å†Œäº‹ä»¶

```csharp
// âœ… æ¨èï¼šè‡ªåŠ¨ç®¡ç†äº‹ä»¶ç”Ÿå‘½å‘¨æœŸ
public override void RegisterEvent()
{
    AddUIEvent(EventDefined.SomeEvent, OnSomeEvent);
}

// âŒ ä¸æ¨èï¼šéœ€è¦æ‰‹åŠ¨ç®¡ç†
void OnCreate()
{
    GameEvent.AddEventListener(EventDefined.SomeEvent, OnSomeEvent);
}

void OnDestroy()
{
    GameEvent.RemoveEventListener(EventDefined.SomeEvent, OnSomeEvent);
}
```

### 3. UIWidget å¤ç”¨

å¯¹äºå¯å¤ç”¨çš„ UI ç»„ä»¶ï¼Œä½¿ç”¨ UIWidgetï¼š

```csharp
// åˆ›å»ºå¤šä¸ªç›¸åŒçš„ Widget
List<ItemWidget> items = new List<ItemWidget>();
for (int i = 0; i < 10; i++)
{
    var item = CreateWidgetByType<ItemWidget>(m_itemContainer);
    items.Add(item);
}
```

### 4. åˆç†ä½¿ç”¨ Update

åªæœ‰éœ€è¦æ¯å¸§æ›´æ–°çš„ UI æ‰é‡å†™ `OnUpdate`ï¼š

```csharp
// âœ… éœ€è¦å®æ—¶æ›´æ–°çš„ UI
public override void OnUpdate()
{
    UpdateTimer();
}

// âŒ ä¸éœ€è¦æ¯å¸§æ›´æ–°çš„ UIï¼Œä¸é‡å†™ OnUpdate
```

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [äº‹ä»¶æ¨¡å—æ–‡æ¡£](./3-2-äº‹ä»¶æ¨¡å—.md) - äº†è§£äº‹ä»¶ç³»ç»Ÿå¦‚ä½•ä¸ UI æ¨¡å—é…åˆ
- [èµ„æºæ¨¡å—æ–‡æ¡£](./3-1-èµ„æºæ¨¡å—.md) - äº†è§£ UI æ¨¡å—å¦‚ä½•ç®¡ç†èµ„æº
- [æ¡†æ¶æ¦‚è§ˆ](./2-æ¡†æ¶æ¦‚è§ˆ.md) - äº†è§£æ•´ä½“æ¶æ„è®¾è®¡
