# 3-7. æµç¨‹æ¨¡å— - ProcedureModule

## ğŸ”„ æ¨¡å—æ¦‚è¿°

æµç¨‹æ¨¡å—æ˜¯ TEngine æ¡†æ¶ä¸­çš„**å•†ä¸šåŒ–å¯åŠ¨æµç¨‹ç®¡ç†ç³»ç»Ÿ**ï¼Œæä¾›äº†å®Œæ•´çš„æ¸¸æˆå¯åŠ¨ã€èµ„æºæ›´æ–°ã€çƒ­æ›´æ–°ç­‰æµç¨‹æ§åˆ¶ã€‚æµç¨‹æ¨¡å—é‡‡ç”¨çŠ¶æ€æœºæ¨¡å¼ï¼Œç¡®ä¿æ¸¸æˆå¯åŠ¨æµç¨‹çš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### âœ¨ æ ¸å¿ƒä¼˜åŠ¿

1. **ğŸ“‹ å®Œæ•´çš„å•†ä¸šåŒ–æµç¨‹**
   - è¦†ç›–ä»å¯åŠ¨åˆ°è¿›å…¥æ¸¸æˆçš„å®Œæ•´æµç¨‹
   - æ”¯æŒèµ„æºæ›´æ–°ã€çƒ­æ›´æ–°ç­‰å•†ä¸šçº§åŠŸèƒ½
   - å¯è‡ªå®šä¹‰æµç¨‹èŠ‚ç‚¹

2. **ğŸ”„ çŠ¶æ€æœºæ¨¡å¼**
   - æ¸…æ™°çš„æµç¨‹çŠ¶æ€ç®¡ç†
   - æ˜“äºæ‰©å±•å’Œç»´æŠ¤
   - æ”¯æŒæµç¨‹è·³è½¬å’Œå›é€€

3. **ğŸš€ å¼‚æ­¥æµç¨‹æ”¯æŒ**
   - åŸºäº UniTask çš„å¼‚æ­¥æµç¨‹
   - ä¸é˜»å¡ä¸»çº¿ç¨‹
   - æ”¯æŒæµç¨‹è¿›åº¦æ˜¾ç¤º

---

## ğŸ“– æµç¨‹èŠ‚ç‚¹è¯´æ˜

TEngine æä¾›äº†ä»¥ä¸‹æ ‡å‡†æµç¨‹èŠ‚ç‚¹ï¼š

### 1. ProcedureLaunch - æµç¨‹å¯åŠ¨

æ¸¸æˆå¯åŠ¨å…¥å£ï¼Œåˆå§‹åŒ–åŸºç¡€ç³»ç»Ÿã€‚

### 2. ProcedureSplash - æµç¨‹é—ªå±

æ˜¾ç¤ºæ¸¸æˆå¯åŠ¨ç”»é¢ï¼ˆSplash Screenï¼‰ã€‚

### 3. ProcedureInitPackage - æµç¨‹åˆå§‹åŒ– Package

åˆå§‹åŒ–èµ„æºåŒ…ç³»ç»Ÿï¼ˆYooAssetï¼‰ã€‚

### 4. ProcedurePreload - æµç¨‹é¢„åŠ è½½

é¢„åŠ è½½å¿…è¦çš„èµ„æºï¼ˆå¦‚é…ç½®è¡¨ã€åŸºç¡€ UI ç­‰ï¼‰ã€‚

### 5. ProcedureInitResources - æµç¨‹åˆå§‹åŒ– Resources

åˆå§‹åŒ–èµ„æºæ¨¡å—ã€‚

### 6. ProcedureUpdateVersion - æµç¨‹æ›´æ–°ç‰ˆæœ¬ Version

æ£€æŸ¥å¹¶æ›´æ–°èµ„æºåŒ…ç‰ˆæœ¬ã€‚

### 7. ProcedureUpdateManifest - æµç¨‹æ›´æ–° Manifest æ¸…å•

æ›´æ–°èµ„æºæ¸…å•æ–‡ä»¶ã€‚

### 8. ProcedureCreateDownloader - æµç¨‹åˆ›å»ºä¸‹è½½å™¨

åˆ›å»ºèµ„æºä¸‹è½½å™¨ï¼Œç”¨äºä¸‹è½½æ›´æ–°èµ„æºã€‚

### 9. ProcedureDownloadFile - æµç¨‹ä¸‹è½½æ–‡ä»¶

ä¸‹è½½éœ€è¦æ›´æ–°çš„èµ„æºæ–‡ä»¶ã€‚

### 10. ProcedureDownloadOver - æµç¨‹ä¸‹è½½æ–‡ä»¶ç»“æŸ

èµ„æºä¸‹è½½å®Œæˆå¤„ç†ã€‚

### 11. ProcedureClearCache - æµç¨‹æ¸…ç†ç¼“å­˜

æ¸…ç†ä¸éœ€è¦çš„ç¼“å­˜æ–‡ä»¶ã€‚

### 12. ProcedureLoadAssembly - æµç¨‹åŠ è½½è¿›å…¥çƒ­æ›´æ–°ç¨‹åºé›†

åŠ è½½çƒ­æ›´æ–°ç¨‹åºé›†ï¼ˆHybridCLRï¼‰ã€‚

### 13. ProcedureStartGame - æµç¨‹å¼€å§‹æ¸¸æˆ

è¿›å…¥æ¸¸æˆä¸»æµç¨‹ã€‚

---

## ğŸ”„ æµç¨‹æ‰§è¡Œé¡ºåº

æ ‡å‡†æµç¨‹æ‰§è¡Œé¡ºåºï¼š

```
ProcedureLaunch
  â†“
ProcedureSplash
  â†“
ProcedureInitPackage
  â†“
ProcedurePreload
  â†“
ProcedureInitResources
  â†“
ProcedureUpdateVersion
  â†“
ProcedureUpdateManifest
  â†“
ProcedureCreateDownloader
  â†“
ProcedureDownloadFile
  â†“
ProcedureDownloadOver
  â†“
ProcedureClearCache
  â†“
ProcedureLoadAssembly
  â†“
ProcedureStartGame
```

---

## ğŸ’¡ è‡ªå®šä¹‰æµç¨‹

### åˆ›å»ºè‡ªå®šä¹‰æµç¨‹èŠ‚ç‚¹

```csharp
/// <summary>
/// è‡ªå®šä¹‰æµç¨‹èŠ‚ç‚¹ã€‚
/// </summary>
public class ProcedureCustom : ProcedureBase
{
    public override async void OnEnter(IFsm<ProcedureModule> fsm)
    {
        base.OnEnter(fsm);
        
        // æµç¨‹è¿›å…¥é€»è¾‘
        Log.Info("è¿›å…¥è‡ªå®šä¹‰æµç¨‹");
        
        // æ‰§è¡Œå¼‚æ­¥æ“ä½œ
        await DoSomethingAsync();
        
        // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæµç¨‹
        ChangeState<ProcedureNext>(fsm);
    }
    
    public override void OnUpdate(IFsm<ProcedureModule> fsm, float elapseSeconds, float realElapseSeconds)
    {
        base.OnUpdate(fsm, elapseSeconds, realElapseSeconds);
        
        // æµç¨‹æ›´æ–°é€»è¾‘
    }
    
    public override void OnLeave(IFsm<ProcedureModule> fsm, bool isShutdown)
    {
        base.OnLeave(fsm, isShutdown);
        
        // æµç¨‹ç¦»å¼€é€»è¾‘
        Log.Info("ç¦»å¼€è‡ªå®šä¹‰æµç¨‹");
    }
    
    private async UniTask DoSomethingAsync()
    {
        // å¼‚æ­¥æ“ä½œ
        await UniTask.Delay(1000);
    }
}
```

### æ³¨å†Œè‡ªå®šä¹‰æµç¨‹

åœ¨æµç¨‹æ¨¡å—åˆå§‹åŒ–æ—¶æ³¨å†Œè‡ªå®šä¹‰æµç¨‹ï¼š

```csharp
// åœ¨ ProcedureModule ä¸­æ³¨å†Œ
ProcedureBase[] procedures = {
    new ProcedureLaunch(),
    new ProcedureSplash(),
    // ... å…¶ä»–æµç¨‹
    new ProcedureCustom(),  // è‡ªå®šä¹‰æµç¨‹
    new ProcedureStartGame(),
};
```

---

## ğŸ”§ API å‚è€ƒ

### æµç¨‹åˆ‡æ¢

```csharp
/// <summary>
/// åˆ‡æ¢åˆ°æŒ‡å®šæµç¨‹ã€‚
/// </summary>
/// <typeparam name="T">æµç¨‹ç±»å‹ã€‚</typeparam>
/// <param name="fsm">æµç¨‹çŠ¶æ€æœºã€‚</param>
void ChangeState<T>(IFsm<ProcedureModule> fsm) where T : ProcedureBase;
```

### æµç¨‹ç”Ÿå‘½å‘¨æœŸ

```csharp
/// <summary>
/// æµç¨‹è¿›å…¥æ—¶è°ƒç”¨ã€‚
/// </summary>
/// <param name="fsm">æµç¨‹çŠ¶æ€æœºã€‚</param>
public override void OnEnter(IFsm<ProcedureModule> fsm);

/// <summary>
/// æµç¨‹æ›´æ–°æ—¶è°ƒç”¨ã€‚
/// </summary>
/// <param name="fsm">æµç¨‹çŠ¶æ€æœºã€‚</param>
/// <param name="elapseSeconds">é€»è¾‘æµé€æ—¶é—´ã€‚</param>
/// <param name="realElapseSeconds">çœŸå®æµé€æ—¶é—´ã€‚</param>
public override void OnUpdate(IFsm<ProcedureModule> fsm, float elapseSeconds, float realElapseSeconds);

/// <summary>
/// æµç¨‹ç¦»å¼€æ—¶è°ƒç”¨ã€‚
/// </summary>
/// <param name="fsm">æµç¨‹çŠ¶æ€æœºã€‚</param>
/// <param name="isShutdown">æ˜¯å¦å…³é—­ã€‚</param>
public override void OnLeave(IFsm<ProcedureModule> fsm, bool isShutdown);
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æµç¨‹èŠ‚ç‚¹èŒè´£å•ä¸€

æ¯ä¸ªæµç¨‹èŠ‚ç‚¹åº”è¯¥åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„ä»»åŠ¡ï¼š

```csharp
// âœ… æ¨èï¼šèŒè´£å•ä¸€
public class ProcedureUpdateVersion : ProcedureBase
{
    // åªè´Ÿè´£ç‰ˆæœ¬æ›´æ–°
}

// âŒ ä¸æ¨èï¼šèŒè´£è¿‡å¤š
public class ProcedureUpdateEverything : ProcedureBase
{
    // åŒæ—¶è´Ÿè´£ç‰ˆæœ¬æ›´æ–°ã€èµ„æºæ›´æ–°ã€é…ç½®åŠ è½½ç­‰
}
```

### 2. ä½¿ç”¨å¼‚æ­¥æ“ä½œ

å¯¹äºè€—æ—¶æ“ä½œï¼Œä½¿ç”¨å¼‚æ­¥æ–¹å¼ï¼š

```csharp
// âœ… æ¨èï¼šå¼‚æ­¥æ“ä½œ
public override async void OnEnter(IFsm<ProcedureModule> fsm)
{
    await UpdateVersionAsync();
    ChangeState<ProcedureNext>(fsm);
}
```

### 3. æä¾›æµç¨‹è¿›åº¦åé¦ˆ

å¯¹äºéœ€è¦æ—¶é—´çš„æµç¨‹ï¼Œæä¾›è¿›åº¦åé¦ˆï¼š

```csharp
public override async void OnEnter(IFsm<ProcedureModule> fsm)
{
    var downloader = GameModule.Resource.CreateResourceDownloader();
    
    // æ˜¾ç¤ºè¿›åº¦
    while (!downloader.IsDone)
    {
        float progress = downloader.Progress;
        UpdateProgressUI(progress);
        await UniTask.Yield();
    }
    
    ChangeState<ProcedureNext>(fsm);
}
```

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [èµ„æºæ¨¡å—æ–‡æ¡£](./3-1-èµ„æºæ¨¡å—.md) - äº†è§£èµ„æºæ¨¡å—çš„åˆå§‹åŒ–æµç¨‹
- [é…ç½®è¡¨æ¨¡å—æ–‡æ¡£](./3-6-é…ç½®è¡¨æ¨¡å—.md) - äº†è§£é…ç½®è¡¨çš„åŠ è½½æµç¨‹
- [æ¡†æ¶æ¦‚è§ˆ](./2-æ¡†æ¶æ¦‚è§ˆ.md) - äº†è§£æ•´ä½“æ¶æ„è®¾è®¡
